<?xml version='1.0' standalone='yes'?><PLUGIN><!--2011-09-30 - first release2011-10-02 - changed icon to show up under network services2011-10-04 - Added apcaccess output to page with service is running2011-10-05 - Fixed versioning and updated package cleanup2011-10-11 - Updated to apcupsd 3.14.10, converted apply script to php and allowed for more options/configuration2011-10-12 - 2atv-Beta1, implented slimmed down status info on top of screen. Needs some formatting/css work. Added abilited to show/hide full ups status2011-10-12 - 2atv-Beta2, Added abilited to show/hide full ups status2011-10-16 - Added coloring to status info on top of page, thanks to speeding_ant2013-07-16 - Riot - Changed package urls to RLWorkman's version and added alternate in case that one goes down (thanks mace5805) added zoggy's fix for the fatal pid log rotation error http://lime-technology.com/forum/index.php?topic=16537.0 (thanks zoggy) Changed name to reflect changed package version. All other code thanks to SeeDrs.2014-01-24 - PAOB - Converted to 14.1 x86_642014-03-04 - PAOB - Incorporated dlandon's powerdown v2.062014-03-31 - hoxbox382 - 3.14.12-x86_64-4 package2014-04-01 - Neil Robinson - Modifications to check for the apcupsd powerfail file, and allow the UPS to power off the system2014-04-19 - dmacias72 - Added diffrent image, UPS Load diplay, timezone fixThe plugin provides APCUPSD support for unRAID systems.--><FILE Name="/boot/packages/apcupsd-3.14.12-x86_64-4_SBo.tgz" Run="upgradepkg --install-new"><URL>https://dl.dropboxusercontent.com/u/35005524/apcupsd-3.14.12-x86_64-4_SBo.tgz</URL></FILE><FILE Name="/boot/packages/powerdown-2.06-noarch-unRAID.tgz" Run="CTRLALTDEL=YES upgradepkg --install-new"><URL>--no-check-certificate https://github.com/dlandon/unraid-snap/raw/master/powerdown-2.06-noarch-unRAID.tgz</URL></FILE><FILE Name="/boot/config/plugins/apcupsd/apcupsd.png"><URL>https://raw.githubusercontent.com/dmacias72/unRAID_6.0/master/apcupsd.png</URL></FILE><FILE Name="/boot/config/plugins/apcupsd/apcupsd.cfg"><INLINE><![CDATA[# apcupsd configurationSERVICE="disable"UPSCABLE="usb"UPSTYPE="usb"DEVICE=""BATTERYLEVEL="10"MINUTES="10"TIMEOUT="300"KILLUPS="NO"SHOWFULLSTATUS="NO"]]></INLINE></FILE><FILE Name="/tmp/apcupsd-upgrade" Run="/bin/bash"><INLINE><![CDATA[#Remove currently installed plugin files[ -f /boot/config/plugins/apcupsd/apply ] && rm /boot/config/plugins/apcupsd/apply[ -f /usr/local/emhttp/plugins/apcupsd/apcupsd.php ] && rm -rf /usr/local/emhttp/plugins/apcupsdrm /tmp/apcupsd-upgrade]]></INLINE></FILE><FILE Name="/usr/local/emhttp/plugins/apcupsd/apcupsd.png"><LOCAL>/boot/config/plugins/apcupsd/apcupsd.png</LOCAL></FILE><FILE Name="/usr/local/emhttp/plugins/apcupsd/apcupsd.page"><INLINE><![CDATA[Menu="OtherSettings"Icon="apcupsd.png"Version="3.14.12-x86_64-4_SBo"Author="SeeDrs/PAOB"Type="php"Title="UPS"]]></INLINE></FILE><FILE Name="/usr/local/emhttp/plugins/apcupsd/apcupsd.php"><INLINE><![CDATA[<?PHP$apcupsd_cfg = parse_ini_file( "/boot/config/plugins/apcupsd/apcupsd.cfg");$apcupsd_running = file_exists( "/var/run/apcupsd.pid") ? "yes" : "no";  $status="";  $bcharge="";  $timeleft="";    if ($apcupsd_running=="yes") {    $acpaccessoutput=`/sbin/apcaccess`;       if ($acpaccessoutput != "")    {      //status      $statusstartpos = strpos($acpaccessoutput, "STATUS   :") + 11;      $statusendpos = strpos($acpaccessoutput, "\n", $statusstartpos) -1;      $status = substr($acpaccessoutput, $statusstartpos, $statusendpos-$statusstartpos);            //bcharge      $bchargestartpos = strpos($acpaccessoutput, "BCHARGE  :") +11;      $bchargeendpos = strpos($acpaccessoutput, "\n", $bchargestartpos);      $bcharge = substr($acpaccessoutput, $bchargestartpos, $bchargeendpos-$bchargestartpos);      $bcharge = str_replace(" Percent", "", $bcharge);      $bchargecolour = (round($bcharge) <= 10 ? 'red' : 'green');       //timeleft      $timeleftstartpos = strpos($acpaccessoutput, "TIMELEFT :") +11;      $timeleftendpos = strpos($acpaccessoutput, "\n", $timeleftstartpos);      $timeleft = substr($acpaccessoutput, $timeleftstartpos, $timeleftendpos-$timeleftstartpos);      $timeleftint = preg_replace('/[^0-9\.]/', '', $timeleft);      $timeleftcolour = (round($timeleft) <= 5 ? 'red' : 'green');      //loadpct      $loadpctstartpos = strpos($acpaccessoutput, "LOADPCT  :") +11;      $loadpctendpos = strpos($acpaccessoutput, "\n", $loadpctstartpos);      $loadpct = substr($acpaccessoutput, $loadpctstartpos, $loadpctendpos-$loadpctstartpos);      $loadpctint = preg_replace('/[^0-9\.]/', '', $loadpct);      //nompower      $nompowerstartpos = strpos($acpaccessoutput, "NOMPOWER :") +11;      $nompowerendpos = strpos($acpaccessoutput, "\n", $nompowerstartpos);      $nompower = substr($acpaccessoutput, $nompowerstartpos, $nompowerendpos-$nompowerstartpos);      $nompowerint = preg_replace('/[^0-9\.]/', '', $nompower);            //load      $load=($loadpctint/100)*$nompowerint;      $loadcolour='green';      if ($nompower == "001,032,0755")      {       $load="N/A";       $loadcolour='red';      }      $load .= " Watts";     }       }  ?><style>.green {	color: #6FA239;	font-size: 14px;}.red {	color: #CC3300;	font-size: 14px;}.status_head {	font-size: 14px;	font-weight: bold;}</style>   <br />   <form name="apcupsd_settings" method="POST" action="/plugins/apcupsd/apcupsdctl.php" target="progressFrame">      <input type="hidden" name="cmd" value="apply">       <table>         <tr>          <td>            <span class="status_head">Daemon: </span><?=($apcupsd_running=="yes")?"<span class=\"green\">Running</span>":"<span class=\"red\">Stopped</span>";?>          </td>          <td>            <span class="status_head">UPS: </span>            <?PHP                switch ($status) {                  case '':                    if ($apcupsd_running=="yes")                      echo("<span class=\"red\">Unknown</span>");                    else                      echo("<span class=\"red\">Offline</span>");                    break;                   case 'ONLINE':                    echo("<span class=\"green\">Online</span>");                    break;                  case 'ONBATT':                     echo("<span class=\"red\">On Battery</span>");                    break;                  case 'COMMLOST':                    echo("<span class=\"red\">Lost Communication</span>");                    break;                  case 'NOBATT':                    echo("<span class=\"red\">No Battery Detected</span>");                    break;                  default:                    echo("<span class=\"red\">$status</span>");                    break;                 }            ?>                </td>          <td>            <? if ($status=="ONLINE" || $status=="ONBATT"): ?><span class="status_head">Battery Charge: </span><span class="<?=$bchargecolour;?>"><?=$bcharge;?>%</span><? endif; ?>          </td>          <td>             <? if ($status=="ONLINE" || $status=="ONBATT"): ?><span class="status_head">Time Left: </span><span class="<?=$timeleftcolour;?>"><?=$timeleft;?></span><? endif; ?>          </td>          <td>             <? if ($status=="ONLINE" || $status=="ONBATT"): ?><span class="status_head">Load: </span><span class="<?=$loadcolour;?>"><?=$load;?></span><? endif; ?>          </td>         </tr>       </table>    <p  class=ContentTitle>        <span class="left">Settings</span>    </p>      <table class="settings">         <tr>         <td>Enable APC UPS Daemon:</td>         <td>          <select name="SERVICE" size="1"  onChange="checkRUNNING(this.form);">            <?=mk_option($apcupsd_cfg['SERVICE'], "disable", "No");?>            <?=mk_option($apcupsd_cfg['SERVICE'], "enable", "Yes");?>          </select>         </td>         </tr>         <tr>         <td>UPS Cable:</td>         <td>           <select id="UPSCABLESELECT" name="UPSCABLESELECT" size="1" onChange="toggleTextBoxDisplay('UPSCABLESELECT', 'CUSTOMUPSCABLE', 'custom'); form.UPSCABLE.value = form.UPSCABLESELECT.value;">            <?=mk_option($apcupsd_cfg['UPSCABLE'], "usb", "usb");?>            <?=mk_option($apcupsd_cfg['UPSCABLE'], "simple", "simple");?>            <?=mk_option($apcupsd_cfg['UPSCABLE'], "smart", "smart");?>            <?=mk_option($apcupsd_cfg['UPSCABLE'], "ether", "network");?>            <?=mk_option($apcupsd_cfg['UPSCABLE'], "custom", "custom");?>          </select>          <input type="hidden" name="UPSCABLE" value="<?=$apcupsd_cfg['UPSCABLE'];?>">          <br>          <input type="text" id="CUSTOMUPSCABLE" name="CUSTOMUPSCABLE" maxlength="40" value="<?=$apcupsd_cfg['CUSTOMUPSCABLE'];?>">         </td>         </tr>         <tr>         <td>UPS Type:</td>         <td>           <select id="UPSTYPESELECT" name="UPSTYPESELECT" size="1"" onChange="form.UPSTYPE.value = form.UPSTYPESELECT.value;">            <?=mk_option($apcupsd_cfg['UPSTYPE'], "usb", "usb");?>            <?=mk_option($apcupsd_cfg['UPSTYPE'], "apcsmart", "apcsmart");?>            <?=mk_option($apcupsd_cfg['UPSTYPE'], "net", "network");?>            <?=mk_option($apcupsd_cfg['UPSTYPE'], "snmp", "snmp");?>            <?=mk_option($apcupsd_cfg['UPSTYPE'], "dumb", "dumb");?>            <?=mk_option($apcupsd_cfg['UPSTYPE'], "pcnet", "pcnet");?>          </select>          <input type="hidden" name="UPSTYPE" value="<?=$apcupsd_cfg['UPSTYPE'];?>">         </td>         </tr>          <tr>         <td>Device:</td>         <td><input type="text" name="DEVICE" maxlength="40" value="<?=$apcupsd_cfg['DEVICE'];?>"></td>         </tr>                                  <tr>         <td>Battery Level:</td>         <td><input type="text" name="BATTERYLEVEL" maxlength="40" value="<?=$apcupsd_cfg['BATTERYLEVEL'];?>"></td>         </tr>                                  <tr>         <td>Minutes:</td>         <td><input type="text" name="MINUTES" maxlength="40" value="<?=$apcupsd_cfg['MINUTES'];?>"></td>         </tr>                                  <tr>         <td>Timeout:</td>         <td><input type="text" name="TIMEOUT" maxlength="40" value="<?=$apcupsd_cfg['TIMEOUT'];?>"></td>         </tr>         <tr>          <td>            Kill UPS:          </td>                    <td>            <select name="KILLUPSSELECT" size="1" onChange="form.KILLUPS.value = form.KILLUPSSELECT.value;">              <?=mk_option($apcupsd_cfg['KILLUPS'], "no", "No");?>              <?=mk_option($apcupsd_cfg['KILLUPS'], "yes", "Yes");?>            </select>            <input type="hidden" name="KILLUPS" value="<?=$apcupsd_cfg['KILLUPS'];?>">               </td>          </tr>                   <tr>          <td>            Show Full Status:          </td>                    <td>            <select id="SHOWFULLSTATUSSELECT" name="SHOWFULLSTATUSSELECT" size="1" onChange="form.SHOWFULLSTATUS.value = form.SHOWFULLSTATUSSELECT.value; toggleDivDisplay('SHOWFULLSTATUSSELECT', 'FULLUPSSTATUS', 'no');">              <?=mk_option($apcupsd_cfg['SHOWFULLSTATUS'], "no", "No");?>              <?=mk_option($apcupsd_cfg['SHOWFULLSTATUS'], "yes", "Yes");?>            </select>            <input type="hidden" name="SHOWFULLSTATUS" value="<?=$apcupsd_cfg['SHOWFULLSTATUS'];?>">               </td>          </tr>                 <tr>         <td></td>         <td><input type="submit" name="runCmd" value="Apply"><button type="button" onClick="done();">Done</button></td>         </tr>      </table>   </form>     <hr>  <div id="FULLUPSSTATUS">  <?PHP     if ($apcupsd_running=="yes") {               $lines = split("\n", $acpaccessoutput);              echo("<p class=ContentTitle>APC UPS Status</p>");       echo("<table  class=\"settings\">");       echo("</tr>");                     foreach ($lines as $line) {          echo("<tr>");                      // echo("$line<br>");             $pos = strpos($line, ":");                        if ($pos !== false){              $right = trim(substr($line, 0, $pos));              $left = trim(substr($line,$pos+2));              echo("<td>");               echo($right);              echo("</td>");               echo("<td>");               echo($left);              echo("</td>");             }            else {              echo("<td>");               echo($line);              echo("</td>");             }          echo("</tr>");                 }                echo("</table>");        }  ?></div><script type="text/javascript">function checkRUNNING(form){   if ("<?=$apcupsd_running;?>" == "yes")       readOnlyForm(form, true);   else       readOnlyForm(form, form.SERVICE.value == "enable");}function readOnlyForm(form, isReadOnly) {    form.UPSCABLESELECT.disabled = isReadOnly;    form.CUSTOMUPSCABLE.readOnly = isReadOnly;    form.UPSTYPESELECT.disabled = isReadOnly;    form.DEVICE.readOnly = isReadOnly;    form.BATTERYLEVEL.readOnly = isReadOnly;    form.MINUTES.readOnly = isReadOnly;    form.TIMEOUT.readOnly = isReadOnly;    form.KILLUPSSELECT.disabled = isReadOnly;}function toggleTextBoxDisplay(ddlID, tboxID, hidevalue ) {   if (document.getElementById(ddlID).value == hidevalue) {    document.getElementById(tboxID).style.display="block";    document.getElementById(ddlID).focus();  }  else {    document.getElementById(tboxID).style.display="none";    document.getElementById(tboxID).focus();  }}function toggleDivDisplay(ddlID, divID, hidevalue) {   if (document.getElementById(ddlID).value == hidevalue)     document.getElementById(divID).style.visibility = 'hidden';  else     document.getElementById(divID).style.visibility = 'visible'; }toggleDivDisplay('SHOWFULLSTATUSSELECT', 'FULLUPSSTATUS', 'no');toggleTextBoxDisplay('UPSCABLESELECT', 'CUSTOMUPSCABLE', 'custom');checkRUNNING(document.apcupsd_settings);document.apcupsd_settings.form.UPSTYPE.value = document.apcupsd_settings.form.UPSUPSTYPESELECT.value;document.apcupsd_settings.form.UPSCABLE.value = document.apcupsd_settings.form.UPSCABLESELECT.value;document.apcupsd_settings.form.KILLUPS.value = document.apcupsd_settings.form.KILLUPSSELECT.value;document.apcupsd_settings.form.SHOWFULLSTATUS.value = document.apcupsd_settings.form.SHOWFULLSTATUSSELECT.value;</script>]]></INLINE></FILE><FILE Name="/usr/local/emhttp/plugins/apcupsd/apcupsdctl.php"><INLINE><![CDATA[<?PHP  $logfile = "/var/log/plugins/apcupsd";  $configfile = "/boot/config/plugins/apcupsd/apcupsd.cfg";  $apcupsd_installing = file_exists( "/tmp/apcupsd-install") ? "yes" : "no";  date_default_timezone_set(substr(readlink("/etc/localtime-copied-from"), 20));  if ($apcupsd_installing == "no")    $newline = "<br>";  else    $newline = "\n\r";  $cur_dt = date("F j\, Y h:i:s A");  write_log("\nStart: $cur_dt");    $settings = array(    "SERVICE",    "UPSCABLE",    "CUSTOMUPSCABLE",    "UPSTYPE",    "DEVICE",    "BATTERYLEVEL",    "MINUTES",    "TIMEOUT",    "KILLUPS",    "SHOWFULLSTATUS"  );  if ($argv[1] == "autostart") {    $CMD = $argv[1];  } else {    $CMD = $_POST['cmd'];  }  if ($CMD  == "autostart")    $_POST = parse_ini_file( "/boot/config/plugins/apcupsd/apcupsd.cfg");    $SERVICE=$_POST['SERVICE'];  $UPSCABLE=$_POST['UPSCABLE'];  $CUSTOMUPSCABLE=$_POST['CUSTOMUPSCABLE'];  $UPSTYPE=$_POST['UPSTYPE'];  $DEVICE=$_POST['DEVICE'];  $BATTERYLEVEL=$_POST['BATTERYLEVEL'];  $MINUTES=$_POST['MINUTES'];  $TIMEOUT=$_POST['TIMEOUT'];  $KILLUPS=$_POST['KILLUPS'];  $SHOWFULLSTATUS=$_POST['SHOWFULLSTATUS'];      switch ($CMD) {    case 'autostart';    case 'apply':      saveconfig();            if ($SERVICE == "enable") {        applyconfig();        startapcupsd();      }      else        stopapcupsd();      break;     case 'start':      break;    case 'stop':      break;    case 'enable':      break;    case 'disable':      break;    default:    break;  }  /* Fix by dfl for log refresh issue.     If the plugin is installing don't allow this html code to be echoed.  This code during initial     startup would fire off the log refresh problem.  It appears to do a constant refresh of	 the log file.  It is intended to refresh the apc ups daemon plugin screen. */  if ($apcupsd_installing == "no") {    echo("<html>");    echo("<head><script>var goback=parent.location;</script></head>");    echo("<body onLoad=\"parent.location=goback;\"></body>");    echo("</html>");  }    $cur_dt = date("F j\, Y h:i:s A");  write_log("\nEnd: $cur_dt");    function startapcupsd() {    global $newline, $log;    echo("Starting apcupsd...");    exec("/etc/rc.d/rc.apcupsd stop");    sleep(0.5);    exec_log("killall -9 apcupsd");    exec_log("/etc/rc.d/rc.apcupsd start");    sleep(5);    echo("Completed$newline");  }    function stopapcupsd() {    global $newline, $log;    echo("Stopping apcupsd...");    exec_log("/etc/rc.d/rc.apcupsd stop");    sleep(0.5);    exec_log("killall -9 apcupsd");    echo("Completed$newline");  }  function applyconfig() {    echo("Applying Settings...");    global $SERVICE, $UPSCABLE, $CUSTOMUPSCABLE, $UPSTYPE, $DEVICE, $BATTERYLEVEL, $MINUTES, $TIMEOUT, $KILLUPS, $newline, $log;  if ($UPSCABLE == "custom")    exec_log("sed -i -e '/^UPSCABLE/c\\UPSCABLE '$CUSTOMUPSCABLE'' /etc/apcupsd/apcupsd.conf");  else    exec_log("sed -i -e '/^UPSCABLE/c\\UPSCABLE '$UPSCABLE'' /etc/apcupsd/apcupsd.conf");    exec_log("sed -i -e '/^UPSTYPE/c\\UPSTYPE '$UPSTYPE'' /etc/apcupsd/apcupsd.conf");    exec_log("sed -i -e '/^DEVICE/c\\DEVICE '$DEVICE'' /etc/apcupsd/apcupsd.conf");#   Modifications to correctly check for the presence of the apcupsd powerfail file, and allow for the UPS to power off the system    exec_log("! grep -q apcupsd /etc/rc.d/rc.6 && sed -i -e 's/\\/sbin\\/poweroff/if \[ -f \\/etc\\/apcupsd\\/powerfail \]\; then\\n    \\/etc\\/apcupsd\\/apccontrol killpower\\n  else\\n    \\/sbin\\/poweroff\\n  fi/' /etc/rc.d/rc.6");    exec_log("sed -i -e '/^BATTERYLEVEL/c\\BATTERYLEVEL '$BATTERYLEVEL'' /etc/apcupsd/apcupsd.conf");    exec_log("sed -i -e '/^MINUTES/c\\MINUTES '$MINUTES'' /etc/apcupsd/apcupsd.conf");    exec_log("sed -i -e '/^TIMEOUT/c\\TIMEOUT '$TIMEOUT'' /etc/apcupsd/apcupsd.conf");    if ($KILLUPS == "yes") {      exec_log("! grep -q apccontrol /etc/rc.d/rc.6 && sed -i -e '0,\\/sbin\\/poweroff/s/\\/sbin\\/poweroff/\\/etc\\/apcupsd\\/apccontrol killpower/' /etc/rc.d/rc.6");    }    else    {      exec_log("grep -q apccontrol /etc/rc.d/rc.6 && sed -i -e 's/\\/etc\\/apcupsd\\/apccontrol killpower/\\/sbin\\/poweroff/' /etc/rc.d/rc.6");    }    echo("Completed$newline");  }    function saveconfig () {    echo("Saving Settings...");    global $_POST, $configfile, $settings, $newline;    $string .= "#apcupsd configuration\n";    foreach ($_POST as $key=>$value) {      if (in_array($key, $settings)) {        $string .= "$key=\"$value\"\n";      }    }        write_string($configfile, $string, TRUE);        echo("Completed$newline ");  }    function exec_log($cmd) {    $results = exec($cmd);        $results = "\nCMD: $cmd \nResults: $results";    write_log($results);  }  function write_log($contents) {    global $logfile;    write_string($logfile, "$contents\n", FALSE);  }      function write_string ($file, $contents, $overwrite) {    if (file_exists($file)) {      if ($overwrite)          unlink($file);          touch($file);    }    else {      touch($file);    }        $fp = @fopen($file, 'a');    @flock($fp, LOCK_EX);    @fwrite($fp, $contents);    @flock($fp, LOCK_UN);    @fclose($fp);  }  ?>]]></INLINE></FILE><FILE Name="/tmp/apcupsd-install" Run="/bin/bash"><INLINE><![CDATA[#Finish APCUPSD Installecho "/sbin/powerdown" >/etc/apcupsd/doshutdownecho "exit 99" >>/etc/apcupsd/doshutdownchmod 755 /etc/apcupsd/doshutdownsed -i -e "/^WALL=wall/c\WALL=\"mail -s 'unRAID_Server_UPS_Alert' root\"/" /etc/apcupsd/apccontrol#Fatal pid log rotation error fixsed -i -e "s/\$0 stop/\$0 stop\n       sleep 3/" /etc/rc.d/rc.apcupsd#Start APCUPSD if enabledphp /usr/local/emhttp/plugins/apcupsd/apcupsdctl.php "autostart"rm /tmp/apcupsd-install]]></INLINE></FILE><FILE Name="/var/log/plugins/apcupsd"><INLINE><![CDATA[]]></INLINE></FILE></PLUGIN>